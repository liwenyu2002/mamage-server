<!-- .env ç®¡ç†ä¸ CI/CD æµç¨‹è¯´æ˜ -->

## .env æ–‡ä»¶ç®¡ç†æµç¨‹

### âœ… å½“å‰é…ç½®çŠ¶æ€

1. **`.gitignore` å·²é…ç½®**
   ```ignore
   .env           # âœ… æœ¬åœ° .env è¢«å¿½ç•¥ï¼ˆä¸ä¸Šä¼ åˆ° Gitï¼‰
   .env.example   # âœ… ç¤ºä¾‹æ–‡ä»¶è¢«å¿½ç•¥ï¼ˆé¿å…æ³„éœ²ï¼‰
   ```

2. **`.env.example` ä½œä¸ºæ¨¡æ¿**
   - å­˜å‚¨åœ¨ Git ä¸Š
   - å¼€å‘è€…å‚è€ƒå¹¶å¤åˆ¶ä¸ºæœ¬åœ° `.env`
   - åŒ…å«æ‰€æœ‰å¿…éœ€å˜é‡çš„æ³¨é‡Šè¯´æ˜

3. **ECS ä¸Šçš„ `.env`**
   - æ‰‹åŠ¨åˆ›å»ºä¸€æ¬¡
   - æ°¸ä¹…å­˜åœ¨ï¼ˆä¸ä¼šè¢«è¦†ç›–ï¼‰
   - æ¯æ¬¡æµæ°´çº¿éƒ¨ç½²æ—¶è‡ªåŠ¨è¯»å–

---

## å®Œæ•´çš„æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°å¼€å‘æœº     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. git add/commit
         â”‚ 2. git push origin main
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub ä»“åº“         â”‚
â”‚  (åªæœ‰ .env.example) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ GitHub Actions è§¦å‘
         â”‚ (Pull ä»£ç åˆ° runner)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Actions Runner           â”‚
â”‚  (ä¸´æ—¶è™šæ‹Ÿæœºï¼Œæ—  .env)           â”‚
â”‚  1. npm install                  â”‚
â”‚  2. è¯­æ³•æ£€æŸ¥                     â”‚
â”‚  3. å‡†å¤‡éƒ¨ç½²è„šæœ¬                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ SSH rsync åŒæ­¥ä»£ç 
         â”‚ (ä¸åŒ…æ‹¬ .env)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ECS æœåŠ¡å™¨                          â”‚
â”‚  1. æ¥æ”¶æ–°ä»£ç                        â”‚
â”‚  2. .env æ–‡ä»¶ä¸è¢«è¦†ç›– âœ…             â”‚
â”‚  3. npm install --omit=dev           â”‚
â”‚  4. node è¯»å–æœ¬åœ° .env               â”‚
â”‚  5. PM2 åº”ç”¨å¯åŠ¨                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®ç‚¹éªŒè¯

### 1ï¸âƒ£ Git ä¸ä¼šä¸Šä¼  .env
```bash
# åœ¨ä½ çš„å¼€å‘æœºéªŒè¯
git status

# è¾“å‡ºåº”è¯¥æ˜¯ï¼ˆ.env ä¸åœ¨åˆ—è¡¨ä¸­ï¼‰ï¼š
On branch main
nothing to commit, working tree clean

# æˆ–
Untracked files:
  (use "git add <file>..." to include in what will be committed)
        .env      # âŒ ä¸ä¼šè¢« git add

# æŸ¥çœ‹ .gitignore è§„åˆ™
cat .gitignore | grep env
# è¾“å‡ºï¼š
.env
```

### 2ï¸âƒ£ GitHub Actions rsync æ’é™¤ .env
```bash
# .github/workflows/deploy.yml ä¸­çš„ rsync å‘½ä»¤å·²é…ç½®
rsync -avz --delete \
  --exclude ".git/" \
  --exclude "node_modules/" \
  --exclude ".github/" \
  # â† .env è™½ç„¶ä¸åœ¨ exclude æ˜å•é‡Œï¼Œ
  #   ä½†å› ä¸ºåœ¨ .gitignore ä¸­ï¼Œæ‰€ä»¥ GitHub runner æœ¬èº«å°±æ²¡æœ‰å®ƒ
  -e "ssh -p ${{ secrets.DEPLOY_PORT }}" \
  ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/home/liwy/mamage-server/
```

**å…³é”®**ï¼šrsync åŒæ­¥çš„æ˜¯ GitHub runner ä¸Šçš„ä»£ç ï¼Œè€Œ runner ä¸Šæ ¹æœ¬æ²¡æœ‰ .envï¼Œæ‰€ä»¥å³ä½¿æ²¡æœ‰ exclude è§„åˆ™ä¹Ÿä¸ä¼šä¼ è¾“ .envã€‚

### 3ï¸âƒ£ ECS ä¸Šçš„ .env å¦‚ä½•æŒä¹…åŒ–

```bash
# ECS ä¸Šé¦–æ¬¡æ‰‹åŠ¨åˆ›å»º .envï¼ˆä¸€æ¬¡æ€§ï¼‰
ssh user@ecs-ip
cd /home/liwy/mamage-server

# åˆ›å»º .env æ–‡ä»¶
cat > .env << 'EOF'
JWT_SECRET=your-secret-here
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=user
DB_PASSWORD=320911
DB_NAME=mamage
UPLOAD_BASE_URL=https://your-cos.myqcloud.com
# ... å…¶ä»–é…ç½®
EOF

# ä¹‹åæ¯æ¬¡æµæ°´çº¿è¿è¡Œ
# 1. GitHub Actions è§¦å‘
# 2. rsync åŒæ­¥æ–°ä»£ç åˆ° ECSï¼ˆä¸è¦†ç›– .envï¼‰
# 3. npm install åªæ›´æ–° node_modules
# 4. PM2 é‡å¯åº”ç”¨
# 5. åº”ç”¨å¯åŠ¨æ—¶è¯»å–æœ¬åœ° .env âœ…
```

---

## éªŒè¯æœºåˆ¶

### åº”ç”¨å¯åŠ¨æ—¶çš„æ£€æŸ¥
```javascript
// app.js ä¸­
try { require('dotenv').config(); } catch (e) {}

// lib/validateEnv.js
const { validateEnvironment } = require('./lib/validateEnv');
validateEnvironment(true);  // è¿™ä¼šæ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡
```

å¦‚æœ ECS ä¸Šçš„ .env ç¼ºå°‘å¿…éœ€å˜é‡ï¼Œåº”ç”¨ä¼šï¼š
```
âŒ åº”ç”¨å¯åŠ¨å¤±è´¥ï¼šç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡

ç¼ºå¤±é¡¹ï¼š
  - JWT_SECRET
  - DB_PASSWORD

è§£å†³æ–¹æ¡ˆï¼š
  ç¼–è¾‘ ECS ä¸Šçš„ .env æ–‡ä»¶ï¼Œæ·»åŠ ç¼ºå¤±çš„å˜é‡
```

---

## æµ‹è¯• .env æŒä¹…åŒ–

### æœ¬åœ°æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿ ECS åœºæ™¯ï¼‰

```bash
# 1. åˆ é™¤æœ¬åœ° .envï¼ˆæ¨¡æ‹Ÿé¦–æ¬¡éƒ¨ç½²ï¼‰
rm .env

# 2. åˆ›å»ºæ–°çš„ .envï¼ˆæ¨¡æ‹Ÿ ECS ä¸Šæ‰‹åŠ¨åˆ›å»ºçš„ï¼‰
cat > .env << 'EOF'
JWT_SECRET=test-secret
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=user
DB_PASSWORD=320911
DB_NAME=mamage
UPLOAD_SKIP_LOCAL_FILE_CHECK=1
CORS_ORIGIN=http://localhost:5173
EOF

# 3. å¯åŠ¨åº”ç”¨ï¼ˆåº”è¯¥æˆåŠŸï¼‰
node app.js

# 4. æ£€æŸ¥è¾“å‡º
# åº”è¯¥çœ‹åˆ°ï¼š
# âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡
#    - JWT_SECRET: å·²é…ç½®
#    - æ•°æ®åº“: user@127.0.0.1:3306/mamage
```

### ECS ä¸ŠéªŒè¯

```bash
# SSH è¿› ECS
ssh user@ecs-ip

# 1. æ£€æŸ¥ .env æ˜¯å¦å­˜åœ¨
ls -la /home/liwy/mamage-server/.env

# 2. æ£€æŸ¥ .env å†…å®¹
cat /home/liwy/mamage-server/.env

# 3. æ‰‹åŠ¨æµ‹è¯•éªŒè¯è„šæœ¬
cd /home/liwy/mamage-server
node -e "require('dotenv').config(); require('./lib/validateEnv').validateEnvironment(true)"

# 4. æ£€æŸ¥ PM2 æ—¥å¿—ï¼ˆæŸ¥çœ‹åº”ç”¨æ˜¯å¦æ­£ç¡®è¯»å–äº† .envï¼‰
pm2 logs mamage-server --lines 20
```

---

## å¸¸è§é—®é¢˜

### Q1: æµæ°´çº¿æ›´æ–°åï¼Œ.env ä¼šä¸ä¼šè¢«è¦†ç›–ï¼Ÿ
**A**: ä¸ä¼šã€‚rsync ä½¿ç”¨ `--delete` æ ‡å¿—åªä¼šåˆ é™¤è¿œç¨‹ä¸Šæœ‰ä½†æœ¬åœ°ï¼ˆrunnerï¼‰æ²¡æœ‰çš„æ–‡ä»¶ã€‚å› ä¸º runner æ ¹æœ¬æ²¡æœ‰ .envï¼Œæ‰€ä»¥ï¼š
- âœ… .env ä¿ç•™åœ¨ ECS ä¸Š
- âœ… æ–°ä»£ç è¢«åŒæ­¥
- âœ… node_modules è¢«æ›´æ–°

### Q2: å¦‚æœéœ€è¦ä¿®æ”¹ ECS ä¸Šçš„ .envï¼ˆæ¯”å¦‚æ›´æ¢å¯†é’¥ï¼‰ï¼Œæ€ä¹ˆåŠï¼Ÿ
**A**: ç›´æ¥åœ¨ ECS ä¸Šç¼–è¾‘ï¼Œæ— éœ€é€šè¿‡ Gitï¼š
```bash
ssh user@ecs-ip
vim /home/liwy/mamage-server/.env
# ä¿®æ”¹åä¿å­˜ï¼Œç„¶å
pm2 restart mamage-server
```

### Q3: å¦‚ä½•ç¡®è®¤åº”ç”¨è¯»å–äº†æ­£ç¡®çš„ .envï¼Ÿ
**A**: æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼š
```bash
pm2 logs mamage-server | head -30
# åº”è¯¥çœ‹åˆ°ï¼š
# [db] runtime mysql config = {
#   host: '127.0.0.1',
#   port: 3306,
#   user: 'user',
#   password: '****',
#   database: 'mamage'
# }
# âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡
```

### Q4: .env.example å’Œ .env çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
**A**:
- **`.env.example`** (åœ¨ Git ä¸Š) â†’ æ¨¡æ¿ï¼Œç»™å¼€å‘è€…å‚è€ƒ
- **`.env`** (åœ¨ .gitignore) â†’ æœ¬åœ°å®é™…å€¼ï¼Œä¸ä¸Šä¼  Git
- **ECS ä¸Šçš„ `.env`** â†’ ç”Ÿäº§å®é™…å€¼ï¼Œæ‰‹åŠ¨åˆ›å»ºå’Œç»´æŠ¤

---

## æ€»ç»“

| æ­¥éª¤ | æ“ä½œ | ç»“æœ |
|------|------|------|
| 1ï¸âƒ£ æœ¬åœ°å¼€å‘ | ä¿®æ”¹ä»£ç ï¼Œgit push | âœ… .env ä¸è¢«ä¸Šä¼  |
| 2ï¸âƒ£ GitHub Actions | æ‹‰å–ä»£ç ï¼Œè¿è¡Œæµ‹è¯• | âœ… Runner æ²¡æœ‰ .env |
| 3ï¸âƒ£ rsync åŒæ­¥ | åŒæ­¥æ–°ä»£ç åˆ° ECS | âœ… ECS .env ä¿ç•™ |
| 4ï¸âƒ£ ECS å¯åŠ¨ | PM2 è¯»å–æœ¬åœ° .env | âœ… ä½¿ç”¨ ECS çš„é…ç½® |
| 5ï¸âƒ£ åº”ç”¨éªŒè¯ | æ£€æŸ¥æ‰€æœ‰å¿…éœ€ç¯å¢ƒå˜é‡ | âœ… æˆ–æ‹’ç»å¯åŠ¨ |

**ä½ çš„æµç¨‹æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼** ğŸ‰

ä¸€æ—¦åœ¨ ECS ä¸Šåˆ›å»º .env ä¸€æ¬¡ï¼Œä¹‹åæ¯æ¬¡æµæ°´çº¿å®Œæˆéƒ½ä¼šè‡ªåŠ¨è¯»å–å®ƒã€‚
